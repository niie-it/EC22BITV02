@model IEnumerable<CartItem>

@{
	ViewData["Title"] = "Index";
}

<h1>Giỏ hàng</h1>

<div class="cart-table table-responsive">
	<table class="table table-bordered">
		<thead>
			<tr>
				<th class="pro-thumbnail">Thumbnail</th>
				<th class="pro-title">Product</th>
				<th class="pro-price">Price</th>
				<th class="pro-quantity">Quantity</th>
				<th class="pro-subtotal">Total</th>
				<th class="pro-remove">Remove</th>
			</tr>
		</thead>
		<tbody>
			@foreach (var item in Model)
			{
				<tr>
					<td>
						<img src="~/Hinh/HangHoa/@item.Hinh" alt="@item.TenHh" height="100" />
					</td>
					<td>@item.TenHh</td>
					<td>@item.DonGia</td>
					<td>
						<input value="@item.SoLuong" min="0" />
					</td>
					<td>@item.ThanhTien</td>
					<td>
						<a asp-action="RemoveCart" asp-route-id="@item.MaHh">
							Xóa
						</a>

					</td>
				</tr>
			}
		</tbody>
	</table>
	<div>Tổng cộng: @Model.Sum(p => p.ThanhTien).ToString("#,##.0")</div>
	<div style="width:180px;" id="paypal-button-container"></div>
</div>
<script src="https://www.paypal.com/sdk/js?client-id=ARoRCowZvk0yF8GOxF6Glv_zYebMB3WCzd7IEhjCrxR5rtee44I3tbPHTdQy9V4F4yd0eIuTRZwHh3VS"></script>
<script>
	paypal.Buttons({
		style: {
			layout: 'horizontal',
			color: 'silver',
			tagline: 'false'
		},
		async createOrder() {
			const response = await fetch("/payment/create-paypal-order", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
				},
				body: JSON.stringify({

					"value": "@Model.Sum(p => p.ThanhTien)", //Lấy từ giỏ hàng của bạn (client)
					"currency_code": "USD"
				})
			});

			const order = await response.json();
			return order.id;

		},
		async onApprove(data) {
			// Capture the funds from the transaction.
			const response = await fetch(`/payment/capture-paypal-order?orderId=${data.orderID}`, {
				method: "POST"
			});

			const details = await response.json();

			// Show success message to buyer
			  window.location.href = "/payment/PaymentSuccess";
		},

		onCancel(data) {

			// Show a cancel page, or return to cart

			window.location.assign("/your-cancel-page");

		}

	}).render('#paypal-button-container');

</script>

